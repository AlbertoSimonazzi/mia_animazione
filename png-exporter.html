<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNG Exporter - Converti GLB in PNG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #4a9eff;
        }

        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            color: #888;
            font-size: 14px;
        }

        .controls-top {
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-size: 12px;
            color: #888;
            font-weight: 500;
        }

        select, input[type="range"], button {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 14px;
        }

        button {
            cursor: pointer;
            background: linear-gradient(135deg, #4a9eff 0%, #0066cc 100%);
            border: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 158, 255, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-export-all {
            background: linear-gradient(135deg, #6bcb77 0%, #228b22 100%);
            padding: 15px 30px;
            font-size: 16px;
        }

        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .model-card {
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .model-card:hover {
            border-color: rgba(74, 158, 255, 0.5);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .model-preview {
            position: relative;
            width: 100%;
            height: 300px;
            background: #1a1a2e;
            overflow: hidden;
        }

        .model-preview canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .model-info {
            padding: 15px;
        }

        .model-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #4a9eff;
        }

        .model-stats {
            font-size: 12px;
            color: #888;
            margin-bottom: 10px;
        }

        .model-controls {
            display: flex;
            gap: 8px;
        }

        .model-controls button {
            flex: 1;
            padding: 8px;
            font-size: 13px;
        }

        .btn-export {
            background: linear-gradient(135deg, #ffd93d 0%, #cc9900 100%);
            color: #1a1a2e;
        }

        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 250px;
            z-index: 1000;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .status.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .status-close {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            line-height: 20px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .status-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .status-text {
            font-size: 14px;
            color: #4a9eff;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(74, 158, 255, 0.3);
            border-top-color: #4a9eff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .instructions {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instructions ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .instructions li {
            color: #ccc;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è PNG Exporter</h1>
        <p class="subtitle">Converti i tuoi modelli GLB in immagini PNG trasparenti con vista isometrica</p>

        <div class="instructions">
            <h3>üìñ Come usare:</h3>
            <ol>
                <li>Aspetta il caricamento dei modelli (vedi le preview)</li>
                <li>Scegli la vista (Isometrica consigliata per stile VISIOTT)</li>
                <li>Regola zoom se necessario</li>
                <li>Click su "Esporta PNG" per ogni modello singolarmente</li>
                <li>Oppure usa "Esporta Tutti" per scaricare tutti in batch</li>
                <li>I PNG verranno scaricati con nome originale (es: 70000001.png)</li>
            </ol>
        </div>

        <div class="controls-top">
            <div class="controls-grid">
                <div class="control-group">
                    <label>Vista Camera</label>
                    <select id="camera-preset">
                        <option value="isometric" selected>Isometrica 30¬∞ (VISIOTT style)</option>
                        <option value="front">Frontale</option>
                        <option value="top">Dall'alto</option>
                        <option value="side">Laterale</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Risoluzione</label>
                    <select id="resolution">
                        <option value="512">512 x 512</option>
                        <option value="1024" selected>1024 x 1024 (Consigliato)</option>
                        <option value="2048">2048 x 2048</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Zoom Globale</label>
                    <input type="range" id="global-zoom" min="0.5" max="2" step="0.1" value="1">
                </div>
                <div class="control-group">
                    <label>Background</label>
                    <select id="background">
                        <option value="transparent" selected>Trasparente</option>
                        <option value="white">Bianco</option>
                        <option value="black">Nero</option>
                    </select>
                </div>
            </div>
            <button class="btn-export-all" id="export-all">üì¶ Esporta Tutti i PNG</button>
        </div>

        <div id="model-grid" class="model-grid"></div>

        <div class="status" id="status">
            <div class="status-header">
                <span style="color: #888; font-size: 11px;">STATUS</span>
                <button class="status-close" onclick="document.getElementById('status').classList.add('hidden')" title="Chiudi">√ó</button>
            </div>
            <div class="status-text">Caricamento in corso...</div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Configurazione modelli
        const MODELS = [
            { filename: '70000001.glb', name: 'Componente 1' },
            { filename: '70000002.glb', name: 'Componente 2' },
            { filename: '70000003.glb', name: 'Componente 3' },
            { filename: '70000004.glb', name: 'Componente 4' },
            { filename: '70000006.glb', name: 'Componente 5' },
            { filename: '70000008.glb', name: 'Componente 6' },
            { filename: '70000010.glb', name: 'Componente 7' },
            { filename: '70000104.glb', name: 'Macchina Completa Assemblata' }
        ];

        class ModelExporter {
            constructor(modelConfig, container) {
                this.config = modelConfig;
                this.container = container;
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.model = null;

                this.init();
            }

            init() {
                // Card container
                const card = document.createElement('div');
                card.className = 'model-card';

                // Preview container
                const preview = document.createElement('div');
                preview.className = 'model-preview';
                card.appendChild(preview);

                // Info section
                const info = document.createElement('div');
                info.className = 'model-info';

                const name = document.createElement('div');
                name.className = 'model-name';
                name.textContent = this.config.name;
                info.appendChild(name);

                const stats = document.createElement('div');
                stats.className = 'model-stats';
                stats.textContent = 'Caricamento...';
                info.appendChild(stats);
                this.statsEl = stats;

                const controls = document.createElement('div');
                controls.className = 'model-controls';

                const btnExport = document.createElement('button');
                btnExport.className = 'btn-export';
                btnExport.textContent = 'üì• Esporta PNG';
                btnExport.onclick = () => this.exportPNG();
                controls.appendChild(btnExport);
                this.btnExport = btnExport;

                info.appendChild(controls);
                card.appendChild(info);
                this.container.appendChild(card);

                // Setup Three.js
                this.setupScene(preview);
                this.loadModel();
            }

            setupScene(container) {
                // Scene
                this.scene = new THREE.Scene();

                // Camera (ortografica per isometrica)
                const aspect = 1;
                const frustumSize = 10;
                this.camera = new THREE.OrthographicCamera(
                    frustumSize * aspect / -2,
                    frustumSize * aspect / 2,
                    frustumSize / 2,
                    frustumSize / -2,
                    0.1,
                    1000
                );

                // Renderer
                this.renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: true,
                    preserveDrawingBuffer: true
                });
                this.renderer.setSize(300, 300);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.setClearColor(0x000000, 0);
                container.appendChild(this.renderer.domElement);

                // Luci per vista isometrica (flat, no ombre forti)
                const ambient = new THREE.AmbientLight(0xffffff, 2);
                this.scene.add(ambient);

                const light1 = new THREE.DirectionalLight(0xffffff, 1);
                light1.position.set(5, 10, 5);
                this.scene.add(light1);

                const light2 = new THREE.DirectionalLight(0xffffff, 0.5);
                light2.position.set(-5, 5, -5);
                this.scene.add(light2);

                // Controls
                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;

                // Animation loop
                const animate = () => {
                    requestAnimationFrame(animate);
                    this.controls.update();
                    this.renderer.render(this.scene, this.camera);
                };
                animate();
            }

            async loadModel() {
                try {
                    const loader = new GLTFLoader();
                    const gltf = await new Promise((resolve, reject) => {
                        loader.load(this.config.filename, resolve, undefined, reject);
                    });

                    this.model = gltf.scene;
                    this.scene.add(this.model);

                    // Calcola bounding box
                    const box = new THREE.Box3().setFromObject(this.model);
                    const size = box.getSize(new THREE.Vector3());
                    const center = box.getCenter(new THREE.Vector3());

                    // Centra modello
                    this.model.position.sub(center);

                    // Adatta camera
                    const maxDim = Math.max(size.x, size.y, size.z);
                    this.camera.left = -maxDim * 0.6;
                    this.camera.right = maxDim * 0.6;
                    this.camera.top = maxDim * 0.6;
                    this.camera.bottom = -maxDim * 0.6;
                    this.camera.updateProjectionMatrix();

                    // Posiziona camera isometrica
                    this.setCameraPreset('isometric', maxDim);

                    this.statsEl.textContent = `${this.config.filename} ‚Ä¢ ${Math.round(maxDim)} unit√†`;
                    this.btnExport.disabled = false;

                    updateStatus(`‚úì ${this.config.name} caricato`);

                } catch (error) {
                    console.error('Errore caricamento:', error);
                    this.statsEl.textContent = 'Errore caricamento';
                    this.btnExport.disabled = true;
                }
            }

            setCameraPreset(preset, distance = 10) {
                distance = distance * parseFloat(document.getElementById('global-zoom').value);

                switch(preset) {
                    case 'isometric':
                        // Vista isometrica standard (30¬∞)
                        this.camera.position.set(distance, distance * 0.707, distance);
                        this.camera.lookAt(0, 0, 0);
                        break;
                    case 'front':
                        this.camera.position.set(0, 0, distance * 1.5);
                        this.camera.lookAt(0, 0, 0);
                        break;
                    case 'top':
                        this.camera.position.set(0, distance * 1.5, 0);
                        this.camera.lookAt(0, 0, 0);
                        break;
                    case 'side':
                        this.camera.position.set(distance * 1.5, 0, 0);
                        this.camera.lookAt(0, 0, 0);
                        break;
                }

                this.controls.target.set(0, 0, 0);
                this.controls.update();
            }

            exportPNG() {
                const resolution = parseInt(document.getElementById('resolution').value);
                const background = document.getElementById('background').value;

                // Crea canvas temporaneo ad alta risoluzione
                const exportCanvas = document.createElement('canvas');
                exportCanvas.width = resolution;
                exportCanvas.height = resolution;

                const exportRenderer = new THREE.WebGLRenderer({
                    canvas: exportCanvas,
                    antialias: true,
                    alpha: background === 'transparent',
                    preserveDrawingBuffer: true
                });

                exportRenderer.setSize(resolution, resolution);
                exportRenderer.setPixelRatio(1);

                // Imposta background
                if (background === 'transparent') {
                    exportRenderer.setClearColor(0x000000, 0);
                } else if (background === 'white') {
                    exportRenderer.setClearColor(0xffffff, 1);
                } else {
                    exportRenderer.setClearColor(0x000000, 1);
                }

                // Render
                exportRenderer.render(this.scene, this.camera);

                // Export PNG
                exportCanvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.config.filename.replace('.glb', '.png');
                    a.click();
                    URL.revokeObjectURL(url);

                    updateStatus(`‚úì Esportato ${a.download}`);
                }, 'image/png');

                exportRenderer.dispose();
            }
        }

        // Utility
        let statusTimeout;

        function updateStatus(text, autoHide = true) {
            const status = document.getElementById('status');
            status.querySelector('.status-text').textContent = text;

            // Mostra lo status
            status.classList.remove('hidden');

            // Cancella timeout precedente
            if (statusTimeout) {
                clearTimeout(statusTimeout);
            }

            // Auto-hide dopo 3 secondi (solo per messaggi di successo)
            if (autoHide && (text.includes('‚úì') || text.includes('Esportato'))) {
                statusTimeout = setTimeout(() => {
                    status.classList.add('hidden');
                }, 3000);
            }
        }

        // Inizializzazione
        const container = document.getElementById('model-grid');
        const exporters = [];

        MODELS.forEach(modelConfig => {
            const exporter = new ModelExporter(modelConfig, container);
            exporters.push(exporter);
        });

        // Controlli globali
        document.getElementById('camera-preset').addEventListener('change', (e) => {
            exporters.forEach(exp => exp.setCameraPreset(e.target.value));
        });

        document.getElementById('global-zoom').addEventListener('input', (e) => {
            const preset = document.getElementById('camera-preset').value;
            exporters.forEach(exp => exp.setCameraPreset(preset));
        });

        document.getElementById('export-all').addEventListener('click', () => {
            updateStatus('Esportazione batch in corso...');
            exporters.forEach((exp, index) => {
                setTimeout(() => {
                    exp.exportPNG();
                    if (index === exporters.length - 1) {
                        setTimeout(() => {
                            updateStatus('‚úì Tutti i PNG esportati!');
                        }, 500);
                    }
                }, index * 300);
            });
        });

        updateStatus('Caricamento modelli...', false);
    </script>
</body>
</html>
