<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Single Components Exporter - Controllo Orientamento</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #4a9eff;
        }

        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            color: #888;
            font-size: 14px;
        }

        .global-controls {
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .global-controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-size: 12px;
            color: #888;
            font-weight: 500;
        }

        select, button {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 14px;
        }

        button {
            cursor: pointer;
            background: linear-gradient(135deg, #4a9eff 0%, #0066cc 100%);
            border: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 158, 255, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6bcb77 0%, #228b22 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ffd93d 0%, #cc9900 100%);
            color: #1a1a2e;
        }

        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
        }

        .model-card {
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(74, 158, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .model-card:hover {
            border-color: rgba(74, 158, 255, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .model-preview {
            position: relative;
            width: 100%;
            height: 300px;
            background: #1a1a2e;
            overflow: hidden;
        }

        .model-preview canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .model-info {
            padding: 15px;
        }

        .model-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #4a9eff;
        }

        .transform-controls {
            margin: 15px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .slider-group {
            margin-bottom: 10px;
        }

        .slider-group:last-child {
            margin-bottom: 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            font-size: 11px;
            color: #aaa;
        }

        .slider-value {
            font-weight: 600;
            color: #4a9eff;
            min-width: 45px;
            text-align: right;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4a9eff;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: #6bb0ff;
            transform: scale(1.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4a9eff;
            cursor: pointer;
            border: none;
        }

        .card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .card-actions button {
            padding: 8px;
            font-size: 13px;
        }

        .btn-reset {
            background: linear-gradient(135deg, #ff6b6b 0%, #cc0000 100%);
        }

        .btn-export {
            background: linear-gradient(135deg, #ffd93d 0%, #cc9900 100%);
            color: #1a1a2e;
        }

        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 250px;
            z-index: 1000;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .status.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .status-close {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            line-height: 20px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .status-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .status-text {
            font-size: 14px;
            color: #4a9eff;
        }

        #config-file {
            display: none;
        }

        .instructions {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .instructions h3 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .instructions ul {
            margin-left: 20px;
            line-height: 1.8;
        }

        .instructions li {
            color: #ccc;
            font-size: 14px;
        }

        .assembly-preview {
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(74, 158, 255, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .assembly-preview h3 {
            color: #4a9eff;
            margin-bottom: 15px;
            font-size: 18px;
            text-align: center;
        }

        .assembly-canvas-container {
            position: relative;
            width: 100%;
            height: 600px;
            background: #1a1a2e;
            border-radius: 8px;
            overflow: hidden;
        }

        .assembly-canvas-container canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Single Components Exporter</h1>
        <p class="subtitle">Controlla orientamento, posizione e scala di ogni componente individualmente</p>

        <div class="instructions">
            <h3>üìñ Come usare:</h3>
            <ul>
                <li><strong>Vista Globale:</strong> Il riquadro grande mostra TUTTI i componenti assemblati insieme - usa gli slider per vedere se le rotazioni sono corrette quando i pezzi sono sovrapposti</li>
                <li><strong>Rotazione:</strong> Ruota ogni componente su X, Y, Z per correggere l'orientamento</li>
                <li><strong>Posizione:</strong> Sposta il componente per centrarlo meglio</li>
                <li><strong>Scala:</strong> Ingrandisci o riduci il componente</li>
                <li><strong>Reset:</strong> Ripristina valori predefiniti (0, 0, 0, 1.0) - usa "Reset Tutti" per resettare tutti i componenti insieme</li>
                <li><strong>Salva Config:</strong> Scarica la configurazione come JSON per riutilizzarla</li>
                <li><strong>Carica Config:</strong> Carica una configurazione salvata precedentemente</li>
                <li><strong>Esporta PNG:</strong> Esporta il componente con le trasformazioni applicate</li>
            </ul>
        </div>

        <div class="assembly-preview">
            <h3>üîç Vista Assemblaggio Globale - Tutti i Componenti Sovrapposti</h3>
            <div class="assembly-canvas-container" id="assembly-canvas-container"></div>
        </div>

        <div class="global-controls">
            <div class="global-controls-grid">
                <div class="control-group">
                    <label>Risoluzione Export</label>
                    <select id="resolution">
                        <option value="512">512 x 512</option>
                        <option value="1024" selected>1024 x 1024</option>
                        <option value="2048">2048 x 2048</option>
                    </select>
                </div>
                <div class="control-group">
                    <button class="btn-reset" onclick="resetAll()">üîÑ Reset Tutti</button>
                </div>
                <div class="control-group">
                    <button class="btn-primary" onclick="exportAll()">üì¶ Esporta Tutti</button>
                </div>
                <div class="control-group">
                    <button class="btn-secondary" onclick="saveConfig()">üíæ Salva Config JSON</button>
                </div>
                <div class="control-group">
                    <button class="btn-secondary" onclick="loadConfig()">üìÇ Carica Config JSON</button>
                </div>
            </div>
        </div>

        <input type="file" id="config-file" accept=".json">

        <div id="model-grid" class="model-grid"></div>

        <div class="status" id="status">
            <div class="status-header">
                <span style="color: #888; font-size: 11px;">STATUS</span>
                <button class="status-close" onclick="document.getElementById('status').classList.add('hidden')" title="Chiudi">√ó</button>
            </div>
            <div class="status-text">Caricamento in corso...</div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Configurazione componenti
        const COMPONENTS = [
            { filename: '70000001.glb' },
            { filename: '70000002.glb' },
            { filename: '70000003.glb' },
            { filename: '70000004.glb' },
            { filename: '70000006.glb' },
            { filename: '70000008.glb' },
            { filename: '70000010.glb' },
            { filename: '70000104.glb' }
        ];

        // Vista globale assemblaggio
        class AssemblyPreview {
            constructor(container) {
                this.container = container;
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.models = []; // Array di {model, transform}

                this.setupScene();
            }

            setupScene() {
                // Scene
                this.scene = new THREE.Scene();

                // Camera ortografica
                const aspect = this.container.clientWidth / this.container.clientHeight;
                const frustumSize = 15;
                this.camera = new THREE.OrthographicCamera(
                    frustumSize * aspect / -2,
                    frustumSize * aspect / 2,
                    frustumSize / 2,
                    frustumSize / -2,
                    0.1,
                    1000
                );

                // Renderer
                this.renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: true
                });
                this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.setClearColor(0x1a1a2e, 1);
                this.container.appendChild(this.renderer.domElement);

                // Luci
                const ambient = new THREE.AmbientLight(0xffffff, 2);
                this.scene.add(ambient);

                const light1 = new THREE.DirectionalLight(0xffffff, 1);
                light1.position.set(5, 10, 5);
                this.scene.add(light1);

                const light2 = new THREE.DirectionalLight(0xffffff, 0.5);
                light2.position.set(-5, 5, -5);
                this.scene.add(light2);

                // Camera isometrica
                const distance = 20;
                this.camera.position.set(distance, distance * 0.707, distance);
                this.camera.lookAt(0, 0, 0);

                // Controls
                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                this.controls.target.set(0, 0, 0);

                // Animation loop
                const animate = () => {
                    requestAnimationFrame(animate);
                    this.controls.update();
                    this.renderer.render(this.scene, this.camera);
                };
                animate();

                // Handle resize
                window.addEventListener('resize', () => this.handleResize());
            }

            handleResize() {
                const aspect = this.container.clientWidth / this.container.clientHeight;
                const frustumSize = 15;
                this.camera.left = frustumSize * aspect / -2;
                this.camera.right = frustumSize * aspect / 2;
                this.camera.top = frustumSize / 2;
                this.camera.bottom = frustumSize / -2;
                this.camera.updateProjectionMatrix();

                this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
            }

            addModel(gltfScene, index) {
                // Clona il modello per la vista globale
                const modelClone = gltfScene.clone();
                this.scene.add(modelClone);

                // Salva riferimento
                this.models[index] = {
                    model: modelClone,
                    transform: {
                        rotation: { x: 0, y: 0, z: 0 },
                        position: { x: 0, y: 0, z: 0 },
                        scale: 1.0
                    }
                };
            }

            updateTransform(index, transform) {
                if (!this.models[index]) return;

                const modelData = this.models[index];
                modelData.transform = transform;

                // Applica trasformazioni
                modelData.model.rotation.x = transform.rotation.x * (Math.PI / 180);
                modelData.model.rotation.y = transform.rotation.y * (Math.PI / 180);
                modelData.model.rotation.z = transform.rotation.z * (Math.PI / 180);

                modelData.model.position.set(
                    transform.position.x,
                    transform.position.y,
                    transform.position.z
                );

                modelData.model.scale.setScalar(transform.scale);
            }
        }

        class ComponentExporter {
            constructor(config, index, container, assemblyPreview) {
                this.config = config;
                this.index = index;
                this.container = container;
                this.assemblyPreview = assemblyPreview;
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.model = null;
                this.maxDim = 10;

                // Valori di trasformazione
                this.transform = {
                    rotation: { x: 0, y: 0, z: 0 },
                    position: { x: 0, y: 0, z: 0 },
                    scale: 1.0
                };

                this.init();
            }

            init() {
                // Crea card
                const card = document.createElement('div');
                card.className = 'model-card';

                // Preview
                const preview = document.createElement('div');
                preview.className = 'model-preview';
                card.appendChild(preview);

                // Info section
                const info = document.createElement('div');
                info.className = 'model-info';

                const name = document.createElement('div');
                name.className = 'model-name';
                name.textContent = this.config.filename;
                info.appendChild(name);

                // Transform controls
                const transformControls = document.createElement('div');
                transformControls.className = 'transform-controls';

                // Rotation X
                transformControls.appendChild(this.createSlider(
                    'Rotation X', 'rot-x', 0, 360, 1, 0, '¬∞'
                ));

                // Rotation Y
                transformControls.appendChild(this.createSlider(
                    'Rotation Y', 'rot-y', 0, 360, 1, 0, '¬∞'
                ));

                // Rotation Z
                transformControls.appendChild(this.createSlider(
                    'Rotation Z', 'rot-z', 0, 360, 1, 0, '¬∞'
                ));

                // Position X
                transformControls.appendChild(this.createSlider(
                    'Position X', 'pos-x', -10, 10, 0.1, 0, ''
                ));

                // Position Y
                transformControls.appendChild(this.createSlider(
                    'Position Y', 'pos-y', -10, 10, 0.1, 0, ''
                ));

                // Position Z
                transformControls.appendChild(this.createSlider(
                    'Position Z', 'pos-z', -10, 10, 0.1, 0, ''
                ));

                // Scale
                transformControls.appendChild(this.createSlider(
                    'Scale', 'scale', 0.5, 3, 0.1, 1, 'x'
                ));

                info.appendChild(transformControls);

                // Action buttons
                const actions = document.createElement('div');
                actions.className = 'card-actions';

                const btnReset = document.createElement('button');
                btnReset.className = 'btn-reset';
                btnReset.textContent = 'üîÑ Reset';
                btnReset.onclick = () => this.reset();
                actions.appendChild(btnReset);

                const btnExport = document.createElement('button');
                btnExport.className = 'btn-export';
                btnExport.textContent = 'üì• Esporta PNG';
                btnExport.onclick = () => this.exportPNG();
                btnExport.disabled = true;
                actions.appendChild(btnExport);
                this.btnExport = btnExport;

                info.appendChild(actions);
                card.appendChild(info);
                this.container.appendChild(card);

                // Setup Three.js
                this.setupScene(preview);
                this.loadModel();
            }

            createSlider(label, id, min, max, step, defaultValue, unit) {
                const group = document.createElement('div');
                group.className = 'slider-group';

                const labelDiv = document.createElement('div');
                labelDiv.className = 'slider-label';

                const labelText = document.createElement('span');
                labelText.textContent = label;
                labelDiv.appendChild(labelText);

                const valueSpan = document.createElement('span');
                valueSpan.className = 'slider-value';
                valueSpan.id = `${id}-${this.index}`;
                valueSpan.textContent = defaultValue + unit;
                labelDiv.appendChild(valueSpan);

                group.appendChild(labelDiv);

                const slider = document.createElement('input');
                slider.type = 'range';
                slider.min = min;
                slider.max = max;
                slider.step = step;
                slider.value = defaultValue;
                slider.id = `${id}-slider-${this.index}`;

                slider.addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    valueSpan.textContent = value.toFixed(1) + unit;

                    // Update transform
                    if (id.startsWith('rot-')) {
                        const axis = id.split('-')[1];
                        this.transform.rotation[axis] = value;
                    } else if (id.startsWith('pos-')) {
                        const axis = id.split('-')[1];
                        this.transform.position[axis] = value;
                    } else if (id === 'scale') {
                        this.transform.scale = value;
                    }

                    this.applyTransform();
                });

                group.appendChild(slider);
                return group;
            }

            setupScene(container) {
                // Scene
                this.scene = new THREE.Scene();

                // Camera ortografica per vista isometrica
                const aspect = 1;
                const frustumSize = 10;
                this.camera = new THREE.OrthographicCamera(
                    frustumSize * aspect / -2,
                    frustumSize * aspect / 2,
                    frustumSize / 2,
                    frustumSize / -2,
                    0.1,
                    1000
                );

                // Renderer
                this.renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: true,
                    preserveDrawingBuffer: true
                });
                this.renderer.setSize(300, 300);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.setClearColor(0x000000, 0);
                container.appendChild(this.renderer.domElement);

                // Luci
                const ambient = new THREE.AmbientLight(0xffffff, 2);
                this.scene.add(ambient);

                const light1 = new THREE.DirectionalLight(0xffffff, 1);
                light1.position.set(5, 10, 5);
                this.scene.add(light1);

                const light2 = new THREE.DirectionalLight(0xffffff, 0.5);
                light2.position.set(-5, 5, -5);
                this.scene.add(light2);

                // Controls
                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;

                // Animation loop
                const animate = () => {
                    requestAnimationFrame(animate);
                    this.controls.update();
                    this.renderer.render(this.scene, this.camera);
                };
                animate();
            }

            async loadModel() {
                try {
                    const loader = new GLTFLoader();
                    const gltf = await new Promise((resolve, reject) => {
                        loader.load(this.config.filename, resolve, undefined, reject);
                    });

                    this.model = gltf.scene;
                    this.scene.add(this.model);

                    // Calcola bounding box
                    const box = new THREE.Box3().setFromObject(this.model);
                    const size = box.getSize(new THREE.Vector3());
                    const center = box.getCenter(new THREE.Vector3());

                    // Centra modello
                    this.model.position.sub(center);

                    // Adatta camera
                    this.maxDim = Math.max(size.x, size.y, size.z);
                    this.camera.left = -this.maxDim * 0.6;
                    this.camera.right = this.maxDim * 0.6;
                    this.camera.top = this.maxDim * 0.6;
                    this.camera.bottom = -this.maxDim * 0.6;
                    this.camera.updateProjectionMatrix();

                    // Posiziona camera isometrica (30¬∞)
                    const distance = this.maxDim;
                    this.camera.position.set(distance, distance * 0.707, distance);
                    this.camera.lookAt(0, 0, 0);
                    this.controls.target.set(0, 0, 0);
                    this.controls.update();

                    this.btnExport.disabled = false;
                    updateStatus(`‚úì ${this.config.filename} caricato`);

                    // Aggiungi alla vista globale
                    if (this.assemblyPreview) {
                        this.assemblyPreview.addModel(this.model, this.index);
                    }

                } catch (error) {
                    console.error('Errore caricamento:', error);
                    updateStatus(`‚ùå Errore caricamento ${this.config.filename}`);
                }
            }

            applyTransform() {
                if (!this.model) return;

                // Converti rotazioni da gradi a radianti
                this.model.rotation.x = this.transform.rotation.x * (Math.PI / 180);
                this.model.rotation.y = this.transform.rotation.y * (Math.PI / 180);
                this.model.rotation.z = this.transform.rotation.z * (Math.PI / 180);

                // Applica posizione
                this.model.position.set(
                    this.transform.position.x,
                    this.transform.position.y,
                    this.transform.position.z
                );

                // Applica scala
                this.model.scale.setScalar(this.transform.scale);

                // Re-render
                this.renderer.render(this.scene, this.camera);

                // Aggiorna vista globale
                if (this.assemblyPreview) {
                    this.assemblyPreview.updateTransform(this.index, this.transform);
                }
            }

            reset() {
                // Reset trasformazioni
                this.transform = {
                    rotation: { x: 0, y: 0, z: 0 },
                    position: { x: 0, y: 0, z: 0 },
                    scale: 1.0
                };

                // Reset sliders
                document.getElementById(`rot-x-slider-${this.index}`).value = 0;
                document.getElementById(`rot-y-slider-${this.index}`).value = 0;
                document.getElementById(`rot-z-slider-${this.index}`).value = 0;
                document.getElementById(`pos-x-slider-${this.index}`).value = 0;
                document.getElementById(`pos-y-slider-${this.index}`).value = 0;
                document.getElementById(`pos-z-slider-${this.index}`).value = 0;
                document.getElementById(`scale-slider-${this.index}`).value = 1;

                // Reset display values
                document.getElementById(`rot-x-${this.index}`).textContent = '0.0¬∞';
                document.getElementById(`rot-y-${this.index}`).textContent = '0.0¬∞';
                document.getElementById(`rot-z-${this.index}`).textContent = '0.0¬∞';
                document.getElementById(`pos-x-${this.index}`).textContent = '0.0';
                document.getElementById(`pos-y-${this.index}`).textContent = '0.0';
                document.getElementById(`pos-z-${this.index}`).textContent = '0.0';
                document.getElementById(`scale-${this.index}`).textContent = '1.0x';

                this.applyTransform();
                updateStatus(`‚úì ${this.config.filename} resettato`);
            }

            exportPNG() {
                const resolution = parseInt(document.getElementById('resolution').value);

                // Crea canvas temporaneo ad alta risoluzione
                const exportCanvas = document.createElement('canvas');
                exportCanvas.width = resolution;
                exportCanvas.height = resolution;

                const exportRenderer = new THREE.WebGLRenderer({
                    canvas: exportCanvas,
                    antialias: true,
                    alpha: true,
                    preserveDrawingBuffer: true
                });

                exportRenderer.setSize(resolution, resolution);
                exportRenderer.setPixelRatio(1);
                exportRenderer.setClearColor(0x000000, 0);

                // Render con trasformazioni applicate
                exportRenderer.render(this.scene, this.camera);

                // Export PNG
                exportCanvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = this.config.filename.replace('.glb', '.png');
                    a.click();
                    URL.revokeObjectURL(url);

                    updateStatus(`‚úì Esportato ${a.download}`);
                }, 'image/png');

                exportRenderer.dispose();
            }
        }

        // Utility functions
        let statusTimeout;
        const exporters = [];

        function updateStatus(text, autoHide = true) {
            const status = document.getElementById('status');
            status.querySelector('.status-text').textContent = text;
            status.classList.remove('hidden');

            if (statusTimeout) {
                clearTimeout(statusTimeout);
            }

            if (autoHide && (text.includes('‚úì') || text.includes('Esportato'))) {
                statusTimeout = setTimeout(() => {
                    status.classList.add('hidden');
                }, 3000);
            }
        }

        window.resetAll = function() {
            exporters.forEach(exp => exp.reset());
            updateStatus('‚úì Tutti i componenti resettati!');
        };

        window.exportAll = function() {
            updateStatus('Esportazione batch in corso...');
            exporters.forEach((exp, index) => {
                setTimeout(() => {
                    exp.exportPNG();
                    if (index === exporters.length - 1) {
                        setTimeout(() => {
                            updateStatus('‚úì Tutti i PNG esportati!');
                        }, 500);
                    }
                }, index * 300);
            });
        };

        window.saveConfig = function() {
            const config = {
                version: '1.0',
                components: exporters.map(exp => ({
                    filename: exp.config.filename,
                    rotation: exp.transform.rotation,
                    position: exp.transform.position,
                    scale: exp.transform.scale
                }))
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'components-config.json';
            a.click();
            URL.revokeObjectURL(url);

            updateStatus('‚úì Configurazione salvata!');
        };

        window.loadConfig = function() {
            document.getElementById('config-file').click();
        };

        document.getElementById('config-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const config = JSON.parse(event.target.result);

                    if (config.version !== '1.0') {
                        updateStatus('‚ö†Ô∏è Versione config non compatibile');
                        return;
                    }

                    config.components.forEach((cfg, i) => {
                        if (exporters[i]) {
                            exporters[i].transform.rotation = cfg.rotation;
                            exporters[i].transform.position = cfg.position;
                            exporters[i].transform.scale = cfg.scale;

                            // Update sliders
                            document.getElementById(`rot-x-slider-${i}`).value = cfg.rotation.x;
                            document.getElementById(`rot-y-slider-${i}`).value = cfg.rotation.y;
                            document.getElementById(`rot-z-slider-${i}`).value = cfg.rotation.z;
                            document.getElementById(`pos-x-slider-${i}`).value = cfg.position.x;
                            document.getElementById(`pos-y-slider-${i}`).value = cfg.position.y;
                            document.getElementById(`pos-z-slider-${i}`).value = cfg.position.z;
                            document.getElementById(`scale-slider-${i}`).value = cfg.scale;

                            // Update display values
                            document.getElementById(`rot-x-${i}`).textContent = cfg.rotation.x.toFixed(1) + '¬∞';
                            document.getElementById(`rot-y-${i}`).textContent = cfg.rotation.y.toFixed(1) + '¬∞';
                            document.getElementById(`rot-z-${i}`).textContent = cfg.rotation.z.toFixed(1) + '¬∞';
                            document.getElementById(`pos-x-${i}`).textContent = cfg.position.x.toFixed(1);
                            document.getElementById(`pos-y-${i}`).textContent = cfg.position.y.toFixed(1);
                            document.getElementById(`pos-z-${i}`).textContent = cfg.position.z.toFixed(1);
                            document.getElementById(`scale-${i}`).textContent = cfg.scale.toFixed(1) + 'x';

                            // Apply transforms
                            exporters[i].applyTransform();
                        }
                    });

                    updateStatus('‚úì Configurazione caricata!');
                } catch (error) {
                    console.error('Errore parsing JSON:', error);
                    updateStatus('‚ùå Errore caricamento config');
                }
            };

            reader.readAsText(file);
        });

        // Inizializzazione
        const container = document.getElementById('model-grid');
        const assemblyContainer = document.getElementById('assembly-canvas-container');

        // Crea vista globale assemblaggio
        const assemblyPreview = new AssemblyPreview(assemblyContainer);

        COMPONENTS.forEach((config, index) => {
            const exporter = new ComponentExporter(config, index, container, assemblyPreview);
            exporters.push(exporter);
        });

        updateStatus('Caricamento componenti...', false);
    </script>
</body>
</html>
